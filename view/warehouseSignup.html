<!DOCTYPE html>
<html>

<head>
	<title>Signup Form for Government Warehouses</title>
</head>

<body>

	<h1>Signup Form for Government Warehouses</h1>

	<!-- <form method="post" action="submit-form.php"> -->
	<label for="name">Name:</label>
	<input type="text" id="name" name="name" required>
	<br><br>
	<label for="address">Address:</label>
	<input type="text" id="address" name="address" required>
	<br><br>
	<label for="city">City:</label>
	<input type="text" id="city" name="city" required>
	<br><br>
	<label for="state">State:</label>
	<input type="text" id="state" name="state" required>
	<br><br>
	<label for="email">Email Address:</label>
	<input type="email" id="email" name="email" required>
	<br><br>
	<label for="phone">Phone Number:</label>
	<input type="tel" id="phone" name="phone" required>
	<br><br>
	<label for="password">Password:</label>
	<input type="password" id="password" name="password" required>
	<br><br>
	<label for="certificate">Upload Government Verified Warehouse Certificate:</label>
	<input type="file" id="certificate" name="certificate" accept=".pdf,.jpg,.jpeg" required>
	<br><br>
	<label for="government-id">Government ID:</label>
	<input type="text" id="government-id" name="government-id" required>
	<br><br>
	<input type="submit" id='signUp' name="signup_submit" value="Sign up" />
	<!-- </form> -->

	<form id="loginForm">
		<label for="loginEmail">Email:</label>
		<input type="email" id="loginEmail" name="loginEmail">

		<label for="loginPassword">Password:</label>
		<input type="password" id="loginPassword" name="loginPassword">

		<button type="submit">Log In</button>
		<a href="/view/wareDashboard.html"> Dashboard </a>
	</form>
	<button class="logout">Log Out</button>
	<div id="message"></div>

	<form id="warehousedataForm">
		<h3>Warehouse Data</h3>
		<label for="warehousename">Warehouse Name:</label>
		<input type="text" id="warehousename" name="warehousename">
		<br>
		<label for="warehouseTotalQuantity">warehouse capacity:</label>
		<input type="number" id="warehouseTotalQuantity" name="warehouseTotalQuantity">
		<br>
		<div>
			<label for="crop1">chole 1:</label>
			<input type="checkbox" id="crop1" name="crop[]" value="chole">
			<input type="number" id="crop1Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">coffee beans 2:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="coffee beans">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">lentils 3:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="lentils">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">maize 3:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="maize">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">moong dal 4:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="moong dal">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">moth beans 5:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="moth beans">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">pigeon peas 6:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="pigeon peas">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">rajma 7:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="rajma">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">rice 8:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="rice">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<div>
			<label for="crop2">blackgram 9:</label>
			<input type="checkbox" id="crop2" name="crop[]" value="blackgram">
			<input type="number" id="crop2Qty" name="cropQty[]" min="0">
		</div>
		<!-- repeat for crop3 to crop10 -->
		<div>
			<label for="crop10">wheat 10:</label>
			<input type="checkbox" id="crop10" name="crop[]" value="wheat">
			<input type="number" id="crop10Qty" name="cropQty[]" min="0">
		</div>
		<button type="submit">Submit</button>
	</form>
</body>
<script type="module">
	const signUp = document.getElementById("signUp");
	var loginForm = document.getElementById("loginForm");
	var loginEmailField = document.getElementById("loginEmail").value;
	var loginPasswordField = document.getElementById("loginPassword").value;
	var messageDiv = document.getElementById("message");
	var warehousedataForm = document.querySelector("#warehousedataForm");
	localStorage.removeItem('loggedIn');
	const logOut = document.querySelector('.logout')




	import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
	import { getFirestore, setDoc, addDoc, updateDoc, deleteDoc, getDocs, doc, collection } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js";
	import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-auth.js";

	// Your web app's Firebase configuration
	const firebaseConfig = {
		apiKey: "AIzaSyCMsJalWUl6wUV_FD4C44TRF8rjBgK5Nic",
		authDomain: "pravidhi-f594d.firebaseapp.com",
		databaseURL: "https://pravidhi-f594d-default-rtdb.firebaseio.com",
		projectId: "pravidhi-f594d",
		storageBucket: "pravidhi-f594d.appspot.com",
		messagingSenderId: "381566880784",
		appId: "1:381566880784:web:3fc0de71affe76c2088e95"
	};

	// Initialize Firebase
	const app = initializeApp(firebaseConfig);
	const db = getFirestore(app);
	const auth = getAuth();
	const wareHouseColRef = collection(db, 'warehouse')


	signUp.addEventListener('click', (e) => {
		var crops = [];
		var Name = document.getElementById('name').value;
		var address = document.getElementById('address').value;
		var city = document.getElementById('city').value;
		var state = document.getElementById('state').value
		var email = document.getElementById('email').value;
		var soilType = document.getElementById('phone').value;
		var password = document.getElementById('password').value;
		// var cropsWheat = document.getElementById('crops-wheat').value;
		// var cropsCorn = document.getElementById('crops-corn').value;
		// var cropsRice = document.getElementById('crops-rice').value;
		var certificate = document.getElementById('certificate').value;
		var governmentId = document.getElementById('government-id').value;


		console.log(Name, address, city, state, email, soilType, password, governmentId);
		createUserWithEmailAndPassword(auth, email, password)
			.then((userCredential) => {
				console.log("HELLO: " + userCredential.user.uid);
				const user = userCredential.user;
				const uid = user.uid;
				const userDocRef = doc(wareHouseColRef, uid);
				const warehouseDetailsRef = collection(userDocRef, "warehouse-details");


				setDoc(userDocRef, {
					Name: Name,
					address: address,
					city: city,
					state: state,
					email: email,
					soilType: soilType,
					password: password,
					certificate: certificate,
					governmentId: governmentId
				})

				alert('user created!');
				// getDocs();
			})
			.catch((error) => {
				// getDocs();
				const errorCode = error.code;
				const errorMessage = error.message;

				alert(errorMessage);
			});
	});


	loginForm.addEventListener('submit', (e) => {
		event.preventDefault();
		console.log(loginForm);
		const loginEmail = loginForm.elements["loginEmail"].value;
		const loginPassword = loginForm.elements["loginPassword"].value;

		console.log(loginEmail, loginPassword);
		signInWithEmailAndPassword(auth, loginEmail, loginPassword)
			.then((userCredential) => {
				localStorage.setItem('loggedIn', true);
				console.log("HELLO: " + userCredential.user.uid);
				var user = userCredential.user;
				const uid = userCredential.user.uid;
				console.log(uid,  "bsdk");
				localStorage.setItem('uid', uid);
				const userRef = doc(wareHouseColRef, uid);

				console.log(uid)
				getDocs(wareHouseColRef).then((snapshot) => {

					console.log("hello from firestore");
					let wareHouseDocs = [];
					snapshot.docs.forEach((docs) => {
						const detailsRef = collection(userRef, "warehouse-details")
						getDocs(detailsRef).then((elements) => {
							elements.docs.forEach((doc) => {
								console.log(doc.data().warehouseName);
								// console.log(doc.data().warehouseName, "Hello motherFucker", doc.data().cropDetails);

								wareHouseDocs.push(doc.data())
							});
						})
					});
					console.log(wareHouseDocs);
				}).catch((err) => {
					console.log(err.message);
				})




				warehousedataForm.addEventListener('submit', (e) => {
					event.preventDefault();
					const warehouseName = warehousedataForm.elements["warehousename"].value;
					const warehouseTotalQuantity = warehousedataForm.elements["warehouseTotalQuantity"].value;
					const crops = warehousedataForm.elements['crop[]'];
					const cropQtys = warehousedataForm.elements['cropQty[]'];
					const userDocRef = doc(wareHouseColRef, uid);
					const warehouseDetailsRef = collection(userDocRef, "warehouse-details");
					const warehouseNameRef = doc(warehouseDetailsRef, warehouseName);

					const cropDetails = [];
					const cropImages = [
						{ name: "chole", path: "public/images/crops/chole.jpg" },
						{ name: "coffee beans", path: "public/images/crops/coffee beans.jpg" },
						{ name: "lentils", path: "public/images/crops/lentils.jpg" },
						{ name: "maize", path: "public/images/crops/maize.jpg" },
						{ name: "moong dal", path: "public/images/crops/moong dal.jpg" },
						{ name: "moth beans", path: "public/images/crops/moth beans.jpg" },
						{ name: "pigeon peas", path: "public/images/crops/pigeon peas.jpg" },
						{ name: "rajma", path: "public/images/crops/rajma.jpg" },
						{ name: "rice", path: "public/images/crops/rice.jpg" },
						{ name: "wheat", path: "public/images/crops/wheat.jpg" },
					];

					for (let i = 0; i < crops.length; i++) {
						// console.log(cropImages[i].path);

						if (crops[i].checked && cropQtys[i].value !== '' && cropImages[i].name === crops[i].value) {
							cropDetails.push({
								cropName: crops[i].value,
								cropQty: parseInt(cropQtys[i].value),
								cropImages: cropImages[i].path
							});
						}
					}

					console.log(cropDetails, "crops", warehouseName, warehouseTotalQuantity);

					setDoc(warehouseNameRef, {
						warehouseName: warehouseName,
						warehouseTotalQuantity: warehouseTotalQuantity,
						cropDetails: cropDetails
					});

					updateDoc(userRef, {
						warehouseName: warehouseName
					})
					alert("warehouse Name added")
					// getDocs(wareHouseColRef).then((snapshot) => {
					// 	console.log("hello from firestore");
					// 	let wareHouseDocs = [];
					// 	snapshot.docs.forEach((doc) => {
					// 		// wareHouseDocs.push({ ...doc.data(), id: doc.id })
					// 		getDocs(wareHouseColRef, userDocRef, warehouseDetailsRef).then((subCol) => {
					// 			subCol.docs.forEach((element) => {

					// 				wareHouseDocs.push({ ...element.data() })
					// 			});
					// 		})
					// 	});
					// 	console.log(wareHouseDocs);
					// }).catch((err) => {
					// 	console.log(err.message);
					// })

					console.log(uid);


				});
			})
	})

	logOut.addEventListener('click', () => {
		signOut(auth)
			.then(() => {
				console.log("user signedOut");
				localStorage.removeItem('loggedIn');
			})
			.catch((err) => {
				console.log("User signedOut");
			})
	});


</script>

</html>